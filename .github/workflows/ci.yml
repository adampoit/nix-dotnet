name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Unit tests using nix-unit
  unit-tests:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Enable Flakes
        run: |
          mkdir -p ~/.config/nix
          echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      - name: Run nix-unit tests
        run: nix run github:nix-community/nix-unit -- --flake '.#tests'
        timeout-minutes: 5

  # Code quality checks
  quality:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Enable Flakes
        run: |
          mkdir -p ~/.config/nix
          echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      - name: Check formatting
        run: nix build .#checks.x86_64-linux.fmt --no-link

  # Integration tests (actual SDK downloads)
  integration-basic:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Enable Flakes
        run: |
          mkdir -p ~/.config/nix
          echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      - name: Run basic integration test
        run: |
          system=$(nix eval --impure --raw --expr builtins.currentSystem)
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            nix build .#checks.${system}.integration-test --no-link --option sandbox false
          else
            nix build .#checks.${system}.integration-test --no-link
          fi
        timeout-minutes: 15

  integration-workloads:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Enable Flakes
        run: |
          mkdir -p ~/.config/nix
          echo "experimental-features = nix-command flakes" >> ~/.config/nix/nix.conf

      - name: Run workload integration test
        run: |
          system=$(nix eval --impure --raw --expr builtins.currentSystem)
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            nix build .#checks.${system}.integration-workload-test --no-link --option sandbox false
          else
            nix build .#checks.${system}.integration-workload-test --no-link
          fi
        timeout-minutes: 20
